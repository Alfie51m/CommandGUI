name: Maven Build and Release

on:
  push:
    branches-ignore:
      - '*-ignore'  # Ignore branches with '-ignore' in their names
  pull_request:
    branches-ignore:
      - '*-ignore'  # Ignore pull requests with '-ignore' in branch names
  workflow_dispatch:  # Allow manual triggering of the workflow

jobs:
  build:
    if: ${{ !contains(github.event.head_commit.message, '-ignore') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-build-artifacts
          path: target/*.jar

  release:
    if: >
      ${{ github.event_name == 'push' &&
      startsWith(github.event.head_commit.message, 'Update v') &&
      !contains(github.event.head_commit.message, '-ignore') }}
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Commit Message
        run: |
          echo "Validating commit message..."
          if [[ ! "${{ github.event.head_commit.message }}" =~ ^Update\ v[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Invalid commit message format. Expected 'Update vX.X.X'."
            exit 1
          fi
          echo "Commit message validated."

      - name: Upload to Modrinth
        run: |
          curl -X POST https://api.modrinth.com/v2/project/YOUR_PROJECT_ID/version \
          -H "Authorization: Bearer ${{ secrets.MODRINTH_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "Update v${{ github.event.head_commit.message }}",
            "version_number": "${{ github.event.head_commit.message }}",
            "version_type": "release",
            "files": ["target/*.jar"],
            "changelog": "Your changelog here",
            "dependencies": []
          }'

      - name: Upload to SpigotMC
        run: |
          curl -X POST https://api.spigotmc.org/your-upload-endpoint \
          -H "Authorization: Bearer ${{ secrets.SPIGOTMC_TOKEN }}" \
          -F "file=@target/*.jar" \
          -F "changelog=Your changelog here"

      - name: Upload to Paper Hangar
        run: |
          curl -X POST https://api.papermc.io/hangar/projects/YOUR_PROJECT_NAME/versions \
          -H "Authorization: Bearer ${{ secrets.HANGAR_TOKEN }}" \
          -F "version=Update v${{ github.event.head_commit.message }}" \
          -F "changelog=Your changelog here" \
          -F "jar=@target/*.jar"
